<!doctype html>
<html>
<head>
    <title>Adlibitum - Graphe</title>
    <meta charset="utf-8">
    <link href="node_modules/vis-network/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
    /* palette https://colorhunt.co/palette/152733 */
    body {
      background-color: #444444;
      font-family: 'proxima-nova', Helvetica;  
    }
    #mynetwork {
      width: 100%;
      height: 760px;
      background: #444444;
    }
    #header, #header a {
      color: white;
    }
    #slider {
      width: 550px !important;
      overflow: scroll !important;
      background-color: #efefef;
      padding: 20px;
      color: #222;
    font-size: 16px;
    line-height: 1.5;
    }
    #slider h1 { margin-bottom:40px;}
    #slider h2 { margin-bottom:20px; }
  </style>
</head>
<body>
    <div id="mynetwork"></div>
    <div id='slider'>
        <h1 class="slider-titre">Titre</h1>
        <div class="slider-gallery">
          <a href="https://place-hold.it/1100x750" target="_blank"><img src="https://place-hold.it/150x150" /></a>
          <a href="https://place-hold.it/1100x750" target="_blank"><img src="https://place-hold.it/150x150" /></a>
          <a href="https://place-hold.it/1100x750" target="_blank"><img src="https://place-hold.it/150x150" /></a>
        </div>
        <h2> Présentation courte </h2>
        <p class="slider-chapeau"></p>
          <h2>Présentation longue</h2>
          <p class="slider-contenu"></p>


      </div>
    <script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
  <!-- https://nnattawat.github.io/slideReveal/ -->
  <script src="jquery.slidereveal.min.js"></script>

    <script type="text/javascript" src="node_modules/vis-network/dist/vis-network.min.js"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
  <script>
    //initialize slider
    var slider = $('#slider').slideReveal({
        trigger: $("#trigger"),
        position: "right",
        push: false,
        overlay: true
      });

    function createNode(v) {
      var node = {};
      node.id = v.identity.toInt();
      node.name = v.properties.titre;
      node.label = v.properties.titre;
      if(v.labels[0] == "Personne") {
        node.color = 'rgb(242,161,39)';
        node.size = 10;
      } else if(v.labels[0] == "Ressource") {
        node.color="rgb(170,143,0)";
        node.size = 20;
      } else if(v.labels[0] == "Evenement") {
        node.color="rgb(255,215,0)";
        node.size = 30;
      }
      node.titre = v.properties.titre;
      node.chapeau = v.properties.chapeau;
      node.contenu = v.properties.contenu;
      console.log("created node: ");
      console.log(node);
      return node;
    }

    function createEdge(v) {
      var edge = {};
      edge.id = v.identity.toInt();
      edge.from = v.start.toInt();
      edge.to = v.end.toInt();
      edge.title = '';
      return edge;
    }
    //neo4jDriver.v1.types.Date
    var options = {};
    var nodes = new vis.DataSet([]);
    var edges = new vis.DataSet([]);

    var driver = neo4j.v1.driver("bolt://165.22.206.197", neo4j.v1.auth.basic("neo4j", "neo4j"));
    var session = driver.session();
    session
      .run('MATCH (n)-[r]-(m) OPTIONAL MATCH (p) RETURN n,r,m,p', {limit: 3000})
      .subscribe({
        onNext: (record) => {
        //construction dataPromise
        const dataPromises = Object.values(record.toObject()).map(
          async (v) => {
            //neo4j.v1.types.Node
            if (v instanceof neo4j.v1.types.Node) {
              try {
                node = createNode(v);
                nodes.add(node);
              } catch (e) {
                //console.log(e);
              }

            } else if (v instanceof neo4j.v1.types.Relationship) {
              edge = createEdge(v);
              edges.add(edge);
            }  else if (v instanceof Neo4j.types.Path) {
              var startNode = createNode(v.start);
              var endNode = createNode(v.end);

              nodes.add(startNode);
              nodes.add(endNode);

              for (let obj of v.segments) {
                nodes.add(createNode(obj.start));
                nodes.add(createNode(obj.end));
                edges.add(createEdge(obj.relationship));
              }

            } else if (v instanceof Array) {
              for (let obj of v) {
                if (obj instanceof Neo4j.types.Node) {
                  var node = createNode(obj);
                  nodes.add(node);

                } else if (obj instanceof Neo4j.types.Relationship) {
                  var edge = createEdge(obj);
                  edges.add(edge);
                }
              }
            }
          }
        );
    },
        onCompleted: function () {
          session.close();
        //console.log(nodes);
        //console.log(edges);
        },
        onError: function (error) {
          console.log(error);
        }
      });


    // create a network
    var options = {
        interaction: {
          hover:true,
            navigationButtons: true,
          keyboard: true
        },
        physics: {
              stabilization: false
            },
        autoResize: true,
        nodes : {
          shape: 'dot',
          font:'16px proxima-nova white',
        },
        edges : {
          color: 'white'

        }

      }
    var container = document.getElementById('mynetwork');
    var data = {
      nodes: nodes,
      edges: edges
    };

  var network = new vis.Network(container, data, options);

  

  network.on("selectNode", function (params) {
        console.log('selectNode Event:', params.nodes[0]);
        var currentNode = nodes.get(params.nodes[0]);
        console.log(currentNode.name);
        //populate slider
        $(".slider-titre").html(currentNode.titre);
        $(".slider-chapeau").html(currentNode.chapeau);
        $(".slider-contenu").html(currentNode.contenu);
        slider.slideReveal("show");
    });
  </script>

</body>
</html>